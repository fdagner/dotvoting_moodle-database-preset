<div style="display: none">[[number]]
[[choice]]</div>



<div class="container">
    <h1>üéØ Punktabfrage</h1>
    <p class="subtitle" id="subtitle">Verteile deine Punkte auf die verschiedenen Kriterien</p>

    <div class="points-counter">
        <div class="points-counter-label">Verbleibende Punkte</div>
        <div id="remainingPoints">0</div>
    </div>

    <!-- Dynamisch generierte Kriterien -->
    <div id="criteriaContainer"></div>

    <!-- JSON-Ausgabe f√ºr einzelne Abfrage -->
    <div class="json-section" hidden>
        <h2>üìã Gespeicherte Daten</h2>
     [[json]]
        <div id="jsonDisplay" style="font-family: 'Courier New', monospace; background: #f7fafc; padding: 15px; border-radius: 10px; border: 2px solid #e2e8f0; min-height: 60px;"></div>
    </div>
</div>

<script>
    // Globale Variablen
    let criteria = [];
    let criteriaLabels = {};
    let criteriaIcons = ['üéØ'];
    let totalPoints = 10;
    let maxPerCrit = 10;

    // Zeige Fehlermeldung an
    function showError(message) {
        const container = document.querySelector('.container');
        container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 80px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                <h1 style="color: #dc3545; margin-bottom: 20px;">Konfigurationsfehler</h1>
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin: 20px 0; color: #856404;">
                    <strong>Fehler:</strong> ${message}
                </div>
            </div>
        `;
    }

    // Parse Dropdowns und initialisiere
    function parseDropdowns() {
        // Lese Punktzahl aus dem ersten Dropdown - nimm den ersten verf√ºgbaren Wert
        const numberSelect = document.getElementById('[[number#id]]');
        if (!numberSelect) {
            showError('Punktzahl-Dropdown nicht gefunden');
            return false;
        }
        
        // Finde die erste Option mit einem Wert (nicht leer, nicht "Ausw√§hlen ...")
        let selectedValue = '';
        for (let option of numberSelect.options) {
            if (option.value && option.value !== '' && option.value !== 'Ausw√§hlen ...') {
                selectedValue = option.value;
                break;
            }
        }
        
        if (!selectedValue) {
            showError('Keine g√ºltige Punktzahl im Dropdown gefunden');
            return false;
        }
        
        // Validiere die Punktzahl
        if (!/^\d+$/.test(selectedValue)) {
            showError(`Der Wert "${selectedValue}" ist keine g√ºltige Zahl`);
            return false;
        }
        
        const pointValue = parseInt(selectedValue);
        if (pointValue <= 0 || pointValue > 100) {
            showError(`Die Punktzahl muss zwischen 1 und 100 liegen`);
            return false;
        }
        
        totalPoints = pointValue;
        maxPerCrit = pointValue;
        
        // Lese Kriterien aus dem zweiten Dropdown - nimm alle verf√ºgbaren Optionen
        const choiceSelect = document.getElementById('[[choice#id]]');
        if (!choiceSelect) {
            showError('Kriterien-Dropdown nicht gefunden');
            return false;
        }
        
        // Sammle alle verf√ºgbaren Optionen (au√üer leere/"Ausw√§hlen ...")
        let criteriaList = Array.from(choiceSelect.options)
                               .map(opt => opt.value)
                               .filter(val => val !== '' && val !== 'Ausw√§hlen ...');
        
        if (criteriaList.length === 0) {
            showError('Keine Kriterien im Dropdown gefunden');
            return false;
        }
        
        // Erstelle Kriterien-Arrays mit Sanitizing der Labels
        criteria = [];
        criteriaLabels = {};
        criteriaList.forEach((label, index) => {
            const sanitizedLabel = sanitizeText(label);
            const critId = `crit${index + 1}`;
            criteria.push(critId);
            criteriaLabels[critId] = sanitizedLabel;
        });
        
        // Update subtitle
        document.getElementById('subtitle').textContent = `Verteile deine ${totalPoints} Punkte auf die verschiedenen Kriterien`;
        document.getElementById('remainingPoints').textContent = totalPoints;
        
        return true;
    }

    // Generiere Kriterien-HTML
    function generateCriteria() {
        const container = document.getElementById('criteriaContainer');
        container.innerHTML = '';
        
        criteria.forEach((crit, index) => {
            const icon = criteriaIcons[index % criteriaIcons.length];
            const label = criteriaLabels[crit];
            
            const critDiv = document.createElement('div');
            critDiv.className = 'criterion';
            critDiv.innerHTML = `
                <div class="criterion-header">
                    <label for="${crit}">${icon} ${label}</label>
                    <div class="input-group">
                        <div class="btn-group">
                            <button type="button" class="btn-small" onclick="decrementCriterion('${crit}')">‚àí</button>
                            <button type="button" class="btn-small" onclick="incrementCriterion('${crit}')">+</button>
                        </div>
                        <input type="number" id="${crit}" min="0" max="${maxPerCrit}" value="0" step="1" hidden>
                    </div>
                </div>
                <div class="visual-score" id="visual${index + 1}"></div>
                <div class="comment-section" style="margin-top: 15px;">
                    <label for="${crit}_comment" style="font-size: 0.9em; color: #4a5568; display: block; margin-bottom: 5px;">üí¨ Kommentar (optional):</label>
                    <input type="text" id="${crit}_comment" class="comment-input" placeholder="Begr√ºndung f√ºr deine Punktvergabe..." maxlength="500" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.9em;">
                </div>
            `;
            
            container.appendChild(critDiv);
        });
        
        // Event Listener hinzuf√ºgen
        criteria.forEach(crit => {
            const input = document.getElementById(crit);
            input.addEventListener('input', () => updateScore(crit));
            
            const commentInput = document.getElementById(`${crit}_comment`);
            if (commentInput) {
                commentInput.addEventListener('input', () => updateJson());
            }
        });
    }

    function getSumExcluding(crit) {
        let sum = 0;
        criteria.forEach(c => {
            if (c !== crit) {
                sum += parseInt(document.getElementById(c).value) || 0;
            }
        });
        return sum;
    }

    function updateRemaining() {
        let sum = 0;
        criteria.forEach(crit => {
            sum += parseInt(document.getElementById(crit).value) || 0;
        });
        const remaining = totalPoints - sum;
        const remainingElem = document.getElementById('remainingPoints');
        remainingElem.textContent = remaining;
        if (remaining < 0) {
            remainingElem.classList.add('over');
        } else {
            remainingElem.classList.remove('over');
        }
        return remaining;
    }

    function updateVisual(crit) {
        const value = parseInt(document.getElementById(crit).value) || 0;
        const critIndex = criteria.indexOf(crit) + 1;
        const visualElem = document.getElementById(`visual${critIndex}`);
        if (!visualElem) return;
        
        visualElem.innerHTML = '';
        
        const dotsContainer = document.createElement('div');
        dotsContainer.classList.add('dots-container');
        
        for (let i = 1; i <= maxPerCrit; i++) {
            const point = document.createElement('div');
            point.classList.add('point');
            if (i <= value) {
                point.classList.add('filled');
            } else {
                point.classList.add('empty');
            }
            point.onclick = () => {
                const currentValue = parseInt(document.getElementById(crit).value) || 0;
                if (currentValue === i) {
                    document.getElementById(crit).value = i - 1;
                } else {
                    document.getElementById(crit).value = i;
                }
                updateScore(crit);
            };
            dotsContainer.appendChild(point);
        }
        
        visualElem.appendChild(dotsContainer);
        
        const scoreText = document.createElement('span');
        scoreText.classList.add('score-text');
        scoreText.textContent = `${value} / ${maxPerCrit}`;
        visualElem.appendChild(scoreText);
    }

    // Hilfsfunktion um unerlaubte Zeichen zu entfernen und gegen Scripts zu sch√ºtzen
    function sanitizeText(text) {
        if (!text) return '';
        // Entferne unerlaubte Zeichen wie < > / " & etc.
        text = text.replace(/[<>/&"']/g, '');
        // Sanitisiere weiter
        const tmp = document.createElement('div');
        tmp.textContent = text;
        let clean = tmp.innerHTML;
        // Entferne Script-Versuche
        clean = clean.replace(/<script[^>]*>.*?<\/script>/gi, '');
        clean = clean.replace(/javascript:/gi, '');
        clean = clean.replace(/on\w+\s*=/gi, '');
        return clean.trim();
    }

    function updateJson() {
        const data = {
            totalPoints: totalPoints
        };
        criteria.forEach(crit => {
            const value = parseInt(document.getElementById(crit).value) || 0;
            const label = criteriaLabels[crit];
            const commentInput = document.getElementById(`${crit}_comment`);
            const comment = commentInput ? sanitizeText(commentInput.value) : '';
            
            data[crit] = value;
            data[label] = value;
            
            // Speichere Kommentar NUR mit Label-Key (nicht mit crit-Key)
            if (comment) {
                const commentWithUser = `${comment} (##user##)`;
                data[`${label}_comment`] = commentWithUser;
            }
        });
        const jsonStr = JSON.stringify(data);
        const textarea = document.getElementById('[[json#id]]');
        if (textarea) {
            textarea.value = jsonStr;
        }
        const display = document.getElementById('jsonDisplay');
        if (display) {
            display.textContent = jsonStr;
        }
    }

    function updateScore(crit) {
        const input = document.getElementById(crit);
        if (!input) return;
        
        let value = parseInt(input.value) || 0;
        if (value < 0) value = 0;
        if (value > maxPerCrit) value = maxPerCrit;
        const sumOthers = getSumExcluding(crit);
        const maxAllowed = totalPoints - sumOthers;
        if (value > maxAllowed) value = maxAllowed;
        input.value = value;
        updateVisual(crit);
        updateRemaining();
        updateJson();
    }

    function incrementCriterion(crit) {
        const input = document.getElementById(crit);
        if (!input) return;
        let value = parseInt(input.value) || 0;
        input.value = value + 1;
        updateScore(crit);
    }

    function decrementCriterion(crit) {
        const input = document.getElementById(crit);
        if (!input) return;
        let value = parseInt(input.value) || 0;
        if (value > 0) {
            input.value = value - 1;
            updateScore(crit);
        }
    }

    window.addEventListener('load', () => {
        // Parse Dropdowns
        if (!parseDropdowns()) {
            return;
        }
        
        // Generiere Kriterien-UI
        generateCriteria();
        
        // Lade gespeicherte Daten falls vorhanden
        const textarea = document.getElementById('[[json#id]]');
        const jsonInput = textarea ? textarea.value.trim() : '';
        
        if (jsonInput) {
            try {
                const data = JSON.parse(jsonInput);
                
                // Warte kurz, damit DOM-Elemente sicher erstellt sind
                setTimeout(() => {
                    criteria.forEach(crit => {
                        const label = criteriaLabels[crit];
                        
                        // Lade Punktwerte - versuche verschiedene Keys
                        let value = null;
                        if (data.hasOwnProperty(crit)) {
                            value = data[crit];
                        } else if (data.hasOwnProperty(label)) {
                            value = data[label];
                        }
                        
                        if (value !== null) {
                            const input = document.getElementById(crit);
                            if (input) {
                                input.value = value;
                            }
                        }
                        
                        // Lade Kommentare - versuche verschiedene Keys
                        let commentValue = null;
                        const commentKeyCrit = `${crit}_comment`;
                        const commentKeyLabel = `${label}_comment`;
                        
                        if (data.hasOwnProperty(commentKeyCrit)) {
                            commentValue = data[commentKeyCrit];
                        } else if (data.hasOwnProperty(commentKeyLabel)) {
                            commentValue = data[commentKeyLabel];
                        }
                        
                        if (commentValue) {
                            const commentInput = document.getElementById(`${crit}_comment`);
                            if (commentInput) {
                                // Entferne "(##user##)" vom Ende
                                const cleanComment = commentValue.replace(/\s*\(##user##\)\s*$/, '');
                                commentInput.value = cleanComment;
                            }
                        }
                    });
                    
                    criteria.forEach(updateVisual);
                    updateRemaining();
                    updateJson();
                }, 100);
            } catch (e) {
                console.error('Ung√ºltiges JSON:', e);
                criteria.forEach(updateVisual);
                updateRemaining();
            }
        } else {
            criteria.forEach(updateVisual);
            updateRemaining();
            updateJson();
        }
    });
</script>